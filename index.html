<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Offline Time Logger</title>
<style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #007BFF; color: white; }
    input[type="text"] { width: 90%; padding: 5px; }
    .star { cursor: pointer; font-size: 20px; color: lightgray; }
    .star.selected { color: gold; }
    button { padding: 10px 15px; margin-top: 10px; background: #007BFF; color: white; border: none; cursor: pointer; border-radius: 5px; }
    button:disabled { background: gray; cursor: not-allowed; }
    button:hover:enabled { background: #0056b3; }
</style>
</head>
<body>
<h2>Offline Time Logger</h2>
<label>Redirect Link after Copy: <input type="text" id="redirectLink"></label>
<button onclick="saveRedirectLink()">Save Link</button>

<table id="logTable">
    <thead>
        <tr>
            <th>Date</th>
            <th>Start Time</th>
            <th>End Time</th>
            <th>Task</th>
            <th>Productivity</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<button id="copyBtn" onclick="copyLogs()" disabled>Copy Logs & Redirect</button>

<script>
let logs = JSON.parse(localStorage.getItem('timeLogs')) || [];
let redirectLink = localStorage.getItem('redirectLink') || "https://gemini.google.com/gem/4b5f9c40a65f/ace29c79bcec5ddc";
document.getElementById('redirectLink').value = redirectLink;

function formatDate(d) {
    return d.toLocaleDateString('en-GB');
}
function formatTime(d) {
    return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}
function saveRedirectLink() {
    redirectLink = document.getElementById('redirectLink').value;
    localStorage.setItem('redirectLink', redirectLink);
}
function addLogEntry() {
    let now = new Date();
    let today = formatDate(now);

    if (logs.length > 0 && !logs[logs.length - 1].endTime) {
        logs[logs.length - 1].endTime = formatTime(now);
    } else {
        logs.push({ date: today, startTime: formatTime(now), endTime: '', task: '', rating: 0 });
    }
    localStorage.setItem('timeLogs', JSON.stringify(logs));
    renderLogs();
    if (logs[logs.length - 1].endTime) addLogEntry();
}
function renderLogs() {
    let tbody = document.querySelector('#logTable tbody');
    tbody.innerHTML = '';
    logs.forEach((log, index) => {
        let row = document.createElement('tr');
        row.innerHTML = `
            <td>${log.date}</td>
            <td>${log.startTime}</td>
            <td>${log.endTime}</td>
            <td><input type="text" value="${log.task || ''}" onchange="updateTask(${index}, this.value)"></td>
            <td>${renderStars(index, log.rating || 0)}</td>
        `;
        tbody.appendChild(row);
    });
    toggleCopyButton();
}
function renderStars(index, rating) {
    let stars = '';
    for (let i = 1; i <= 5; i++) {
        stars += `<span class="star ${i <= rating ? 'selected' : ''}" onclick="setRating(${index}, ${i})">â˜…</span>`;
    }
    return stars;
}
function updateTask(index, value) {
    logs[index].task = value.trim();
    localStorage.setItem('timeLogs', JSON.stringify(logs));
    toggleCopyButton();
}
function setRating(index, rating) {
    logs[index].rating = rating;
    localStorage.setItem('timeLogs', JSON.stringify(logs));
    renderLogs();
}
function allLogsValid() {
    return logs.length > 0 && logs.every(l => l.task.trim() !== '' && l.rating > 0);
}
function toggleCopyButton() {
    document.getElementById('copyBtn').disabled = !allLogsValid();
}
function copyLogs() {
    if (!allLogsValid()) return;
    // Fill last end time if missing
    if (!logs[logs.length - 1].endTime) {
        logs[logs.length - 1].endTime = formatTime(new Date());
    }
    // Prepare copy text
    let copyText = logs.map(l => `${l.date}, ${l.startTime}, ${l.endTime}, ${l.task}, ${l.rating}`).join('\n');
    navigator.clipboard.writeText(copyText).then(() => {
        // Clear all copied logs
        logs = [];
        localStorage.setItem('timeLogs', JSON.stringify(logs));
        // Start a new log entry immediately
        let now = new Date();
        logs.push({ date: formatDate(now), startTime: formatTime(now), endTime: '', task: '', rating: 0 });
        localStorage.setItem('timeLogs', JSON.stringify(logs));
        renderLogs();
        window.location.href = redirectLink;
    });
}
window.onload = function() {
    addLogEntry();
};
</script>
</body>
</html>
